{"version":3,"file":"BodyParser.js","sources":["../../../src/utils/BodyParser.js"],"sourcesContent":["import busboy from \"busboy\"\r\n\r\nconst parseMultipartFormData = (req, maxBodySize) => {\r\n\r\n    return new Promise((resolve, reject) => {        \r\n        const bb = busboy({ headers: req.headers })\r\n        const fields = {}\r\n        const files = []\r\n\r\n        let totalSize = 0\r\n        let aborted = false\r\n        const abort = () => {\r\n            aborted = true \r\n            req.unpipe(bb)\r\n            bb.removeAllListeners()\r\n            reject(new Error('payload_too_large'))\r\n        }\r\n\r\n        bb.on('field', (name, value) => {\r\n            if(aborted) return\r\n\r\n            fields[name] = value\r\n\r\n            const fieldSize = Buffer.byteLength(value, 'utf8')\r\n            totalSize += fieldSize\r\n            if(totalSize > maxBodySize &&  maxBodySize > 0) abort()\r\n        })\r\n\r\n        bb.on('file', (name, stream, info) => {\r\n            if(aborted) return\r\n\r\n            const { filename, encoding, mimeType } = info\r\n            const chunks = []\r\n\r\n            stream.on('data', (chunk) => {\r\n                if(aborted) return\r\n\r\n                chunks.push(chunk)\r\n\r\n                totalSize += chunk.length\r\n                if(totalSize > maxBodySize && maxBodySize > 0) abort()\r\n            })\r\n\r\n            stream.on('end', () => {\r\n                if(aborted) return\r\n\r\n                const buffer = Buffer.concat(chunks)\r\n                files.push({ filename, encoding, mimeType, size: buffer.length, buffer })\r\n            })\r\n\r\n            stream.on('error', () => resolve(null))\r\n        })\r\n\r\n        bb.on('finish', () => {\r\n            if(!aborted) resolve({ fields, files })\r\n        })\r\n\r\n        bb.on('error', (err) => {\r\n            resolve(null)\r\n        })\r\n\r\n        req.pipe(bb)\r\n    })\r\n\r\n}\r\n\r\nconst parseJsonData = (req, maxBodySize) => {\r\n    return new Promise((resolve, reject) => {        \r\n        let body = ''\r\n        let totalSize = 0\r\n        let aborted = false\r\n        const abort = () => {\r\n            aborted = true\r\n            reject(new Error('payload_too_large'))\r\n        }\r\n\r\n        req.on('data', (chunk) => {\r\n            if(aborted) return\r\n\r\n            body += chunk.toString()\r\n            totalSize += chunk.length\r\n            if(totalSize > maxBodySize && maxBodySize > 0) abort()\r\n        })\r\n\r\n        req.on('end', () => {\r\n            if(aborted) return \r\n\r\n            try {\r\n                resolve(JSON.parse(body))\r\n            } catch(err) {\r\n                resolve(null)\r\n            }\r\n        })\r\n\r\n        req.on('error', (err) => {\r\n            resolve(null)\r\n        })\r\n    })\r\n}\r\n\r\nexport default async (req, maxBodySize) => {\r\n    if(req.headers['content-type']?.includes('multipart/form-data')) {\r\n        return await parseMultipartFormData(req, maxBodySize)\r\n    } else if(req.headers['content-type']?.includes('application/json')) {\r\n        return await parseJsonData(req, maxBodySize)\r\n    }\r\n}"],"names":["busboy"],"mappings":"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"}